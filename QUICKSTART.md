# Quick Start Guide

This guide walks you through migrating from v1 to v2 and deploying with Docker.

## 1. Migrating Your Config File

### Step 1: Build the Migration Tool

```bash
# Make sure you're on the feature branch
git checkout feature/v2-refactor

# Build the migration tool
go build -o migrate ./cmd/migrate

# Check it works
./migrate
# Should show usage instructions
```

### Step 2: Run Migration

```bash
# Create output directory for new config
mkdir -p ~/backup-config

# Run migration (replace with your actual config path)
./migrate /path/to/your/old_config.json ~/backup-config/

# Expected output:
# ✓ Migration complete!
# ✓ Created: ~/backup-config/config.json
# ✓ Created: ~/backup-config/.pgpass (chmod 600)
```

### Step 3: Review Generated Files

```bash
# Check what was created
ls -la ~/backup-config/
# Should show:
#   config.json
#   .pgpass (with -rw------- permissions)

# Review the new config
cat ~/backup-config/config.json

# Review .pgpass (contains your passwords)
cat ~/backup-config/.pgpass
```

**Example Migration:**

If your old config was:
```json
{
  "databases": [
    {
      "name": "sonarr-main",
      "user": "sonarr",
      "password": "sonarr123",
      "host": "192.168.0.65"
    }
  ],
  "backup_dir": "/backups",
  "retention": 7,
  "log_file": "/backups/log.txt"
}
```

You'll get:

**~/backup-config/config.json:**
```json
{
  "backup_dir": "/backups",
  "global_defaults": {
    "port": 5432,
    "retention_tiers": [
      {
        "tier": "daily",
        "retention": 7
      }
    ],
    "pgpass_file": "/config/.pgpass"
  },
  "max_concurrent_backups": 3,
  "log_level": "info",
  "log_format": "json",
  "databases": [
    {
      "name": "sonarr-main",
      "user": "sonarr",
      "host": "192.168.0.65",
      "enabled": true
    }
  ]
}
```

**~/backup-config/.pgpass:**
```
# PostgreSQL password file
# Format: hostname:port:database:username:password
# Generated by pg_backuper migration tool

192.168.0.65:5432:*:sonarr:sonarr123
```

## 2. Building and Using the Docker Image

### Step 1: Build the Image

```bash
# Make sure you're in the project directory
cd /Users/williamokano/Workspace/Personal/pg_backuper

# Build the Docker image
docker build -t pg_backuper:v2.0 .

# Verify it built
docker images | grep pg_backuper
```

### Step 2: Test the Image (One-Time Run)

```bash
# Test backup manually (one-time run, not scheduled)
docker run --rm \
  --network host \
  -v ~/backup-config:/config:ro \
  -v ~/backups:/backups \
  pg_backuper:v2.0 \
  /usr/local/bin/pg_backuper /config/config.json

# Check the logs
# Should show JSON logs with backup progress
```

### Step 3: Run with Cron (Production)

**Option A: Docker Run**

```bash
docker run -d \
  --name pg_backuper \
  --network host \
  -v ~/backup-config:/config:ro \
  -v ~/backups:/backups \
  -e CONFIG_FILE=/config/config.json \
  -e CRON_SCHEDULE="0 3 * * *" \
  pg_backuper:v2.0

# View logs
docker logs -f pg_backuper

# Stop
docker stop pg_backuper
docker rm pg_backuper
```

**Option B: Docker Compose (Recommended)**

Create `docker-compose.yml`:
```yaml
version: '3.8'
services:
  pg_backuper:
    image: pg_backuper:v2.0
    container_name: pg_backuper
    network_mode: host
    volumes:
      - ~/backup-config:/config:ro
      - ~/backups:/backups
    environment:
      - CONFIG_FILE=/config/config.json
      - CRON_SCHEDULE=0 3 * * *  # 3 AM daily
    restart: unless-stopped
```

Then run:
```bash
docker-compose up -d
docker-compose logs -f
```

**Option C: Portainer Stack**

In Portainer, create a new stack with:

```yaml
version: '3.8'
services:
  pg_backuper:
    image: pg_backuper:v2.0
    container_name: pg_backuper
    network_mode: host
    volumes:
      - /path/to/backup-config:/config:ro
      - /path/to/backups:/backups
    environment:
      - CONFIG_FILE=/config/config.json
      - CRON_SCHEDULE=0 3 * * *
    restart: unless-stopped
```

Or in Portainer UI:
- **Container name**: `pg_backuper`
- **Image**: `pg_backuper:v2.0`
- **Network**: `host`
- **Volumes**:
  - Container: `/config` → Host: `/path/to/backup-config` (read-only)
  - Container: `/backups` → Host: `/path/to/backups`
- **Environment variables**:
  - `CONFIG_FILE=/config/config.json`
  - `CRON_SCHEDULE=0 3 * * *`

## 3. Verify Everything Works

### Check Logs

```bash
# If using docker run
docker logs pg_backuper

# If using docker-compose
docker-compose logs

# Look for JSON logs like:
# {"level":"info","time":"2025-12-17T03:00:00Z","message":"starting pg_backuper v2.0"}
# {"level":"info","database":"sonarr-main","message":"backup completed","duration":1250}
```

### Check Backups Were Created

```bash
ls -lh ~/backups/
# Should show files like:
# sonarr-main--2025-12-17T03-00-00.backup
```

### Test Rotation

```bash
# After several runs, check that old backups are deleted according to retention policy
ls -lh ~/backups/ | grep sonarr-main
```

## 4. Troubleshooting

### If Migration Fails

```bash
# Check old config syntax
cat your_old_config.json | jq .

# Run with more details
./migrate your_old_config.json ~/backup-config/ 2>&1 | tee migration.log
```

### If Docker Build Fails

```bash
# Clean build
docker build --no-cache -t pg_backuper:v2.0 .

# Check Go version
go version  # Should be 1.22+
```

### If Backup Fails

```bash
# Check .pgpass permissions
docker exec pg_backuper ls -la /config/.pgpass
# Should show: -rw-------

# Test pg_dump manually
docker exec -it pg_backuper bash
PGPASSFILE=/config/.pgpass pg_dump -U sonarr -h 192.168.0.65 sonarr-main -f /tmp/test.backup
```

### If Authentication Fails

```bash
# Verify .pgpass format
cat ~/backup-config/.pgpass
# Should be: host:port:database:user:password

# Test connection manually
docker exec -it pg_backuper bash
PGPASSFILE=/config/.pgpass psql -U sonarr -h 192.168.0.65 -d sonarr-main -c '\l'
```

## 5. Quick Reference Commands

```bash
# Build everything
go build -o migrate ./cmd/migrate
docker build -t pg_backuper:v2.0 .

# Migrate config
./migrate old_config.json ~/backup-config/

# Test run (one-time)
docker run --rm --network host \
  -v ~/backup-config:/config:ro \
  -v ~/backups:/backups \
  pg_backuper:v2.0 \
  /usr/local/bin/pg_backuper /config/config.json

# Production run (with cron)
docker run -d --name pg_backuper --network host \
  -v ~/backup-config:/config:ro \
  -v ~/backups:/backups \
  -e CONFIG_FILE=/config/config.json \
  -e CRON_SCHEDULE="0 3 * * *" \
  pg_backuper:v2.0

# View logs
docker logs -f pg_backuper

# Stop
docker stop pg_backuper && docker rm pg_backuper
```

## 6. Advanced Configuration

### Custom Retention Policy

For different backup strategies:

```json
{
  "global_defaults": {
    "retention_tiers": [
      {"tier": "hourly", "retention": 24},   // Last 24 hours
      {"tier": "daily", "retention": 7},      // Last 7 days
      {"tier": "weekly", "retention": 4},     // Last 4 weeks
      {"tier": "monthly", "retention": 12},   // Last 12 months
      {"tier": "yearly", "retention": 5}      // Last 5 years
    ]
  }
}
```

### Per-Database Configuration

Override settings for specific databases:

```json
{
  "global_defaults": {
    "retention_tiers": [{"tier": "daily", "retention": 7}]
  },
  "databases": [
    {
      "name": "critical_db",
      "user": "postgres",
      "host": "db1.example.com",
      "port": 5433,
      "retention_tiers": [
        {"tier": "hourly", "retention": 48},
        {"tier": "daily", "retention": 30}
      ]
    },
    {
      "name": "test_db",
      "user": "postgres",
      "host": "db2.example.com",
      "enabled": false  // Skip this database
    }
  ]
}
```

### Console Logging (Human-Readable)

For development or debugging:

```json
{
  "log_level": "debug",
  "log_format": "console"
}
```

## Next Steps

- Read [MIGRATION.md](MIGRATION.md) for detailed migration information
- Check [README.md](README.md) for complete configuration reference
- Review [CHANGELOG.md](CHANGELOG.md) for all v2.0 changes
